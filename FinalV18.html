<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø´Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght=400;700&display=swap" rel="stylesheet">
<style>
/* -------------------- Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØµÙ…ÙŠÙ… (Ø§Ù„Ø¥ØµØ¯Ø§Ø± V28 - Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„ÙØ§Ù‚Ø¹ Ù„ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ±) -------------------- */

body { 
    font-family: 'Cairo', sans-serif; 
    direction: rtl; 
    margin: 0; 
    background: #f4f7f9; 
    color: #333;
    padding-top: 80px; 
}
header {
    position: fixed; 
    top: 0; 
    width: 100%; 
    background: #1c4587; 
    color: white; 
    text-align: center; 
    padding: 20px 0; 
    font-size: 24px; 
    font-weight: 700; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
    z-index: 1000;
}
.container {
    max-width: 1200px; 
    margin: 20px auto; 
    padding: 15px; 
}
.card {
    background: white;
    padding: 30px; 
    margin-bottom: 25px; 
    border-radius: 15px; 
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); 
}
h2 {
    color: #1c4587; 
    border-bottom: 2px solid #e0e6ec; 
    padding-bottom: 15px;
    margin-top: 0;
    font-size: 22px;
}
.add-form input {
    padding: 14px 15px; 
    margin: 10px 0; 
    width: 100%; 
    box-sizing: border-box; 
    border-radius: 10px; 
    border: 1px solid #c9d2db; 
    font-size: 16px;
    transition: border-color 0.3s;
}
.add-form input:focus {
    border-color: #1c4587;
    outline: none;
}
#addProductButton {
    background: #059669; 
    color: white; 
    border: none; 
    cursor: pointer; 
    padding: 16px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    margin-top: 15px;
    transition: background 0.3s;
}
#addProductButton:hover {
    background: #047857;
}

/* Ù†Ù…Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
#searchKeyDropdown {
    margin-bottom: 20px;
    background: #f9f9f9;
    border: 1px solid #1c4587; 
    border-radius: 10px;
    padding: 12px 15px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
    appearance: none; 
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%231c4587%22%20d%3D%22M287%20173.5c-4%204-10.4%204-14.4%200L146.2%2057.2%2019.8%20173.5c-4%204-10.4%204-14.4%200-4-4-4-10.4%200-14.4l133-133c4-4%2010.4-4%2014.4%200l133%20133c4%204%204%2010.4%200%2014.4z%22%2F%3E%3C%2Fsvg%3E'); 
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 12px;
}


#productsTable {
    width: 100%; 
    border-collapse: collapse; 
    border-spacing: 0;
    margin-top: 0;
}
#productsTable th, #productsTable td {
    padding: 15px; 
    text-align: center;
    border-bottom: 1px solid #e0e6ec;
    transition: background-color 0.3s; 
}

#productsTable td {
    font-size: 17px; 
}

#productsTable th {
    background: #3b82f6; 
    color: white; 
    font-size: 15px;
}

/* -------------------- Ù†Ù…Ø· Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ± (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ù„Ø£Ø­Ù…Ø± Ø§Ù„ÙØ§Ù‚Ø¹) -------------------- */
.not-available {
    background-color: #ff4545 !important; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù‚ÙˆÙŠ ÙˆÙˆØ§Ø¶Ø­ (Ù…Ø«Ù„ Tomato Ø£Ùˆ OrangeRed) */
    color: #333 !important; /* Ù†Øµ ÙŠØ¨Ù‚Ù‰ Ù…Ù‚Ø±ÙˆØ¡ */
    filter: brightness(1.0) !important;
    border-left: 5px solid #ff0000; /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ø­Ù…Ø± ØµØ±ÙŠØ­ */
}

.not-available:nth-child(even) {
     background-color: #ff6060 !important; /* Ø¯Ø±Ø¬Ø© Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ø²ÙˆØ¬ÙŠØ© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© */
}

/* Ù„Ø§ ØªØ³Ù…Ø­ Ù„Ù€ hover Ø¨ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
.not-available:hover {
    background-color: #ff3030 !important;
}

.not-available td { 
    border-bottom-color: #ff4545 !important; 
}
.not-available td[contenteditable="true"] { 
    background: #ff8080 !important; /* Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
    color: #333 !important; 
}
/* ------------------------------------------------------------------------------------ */


/* -------------------- Ø£Ù†Ù…Ø§Ø· ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø« (Ø«Ø§Ø¨ØªØ©) -------------------- */
#productsTable tr { background: #ffffff; color: #333; }
#productsTable tr:hover { filter: brightness(0.95); }
#productsTable tr:nth-child(even) { background: #f8f9fa; }

/* SAM: Ø§Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
.key-sam { background-color: #1a237e !important; color: white !important; }
.key-sam:nth-child(even) { background-color: #3f51b5 !important; }
.key-sam td { border-bottom-color: #3f51b5 !important; }
.key-sam td[contenteditable="true"] { background: #5c6bc0 !important; color: white !important; }

/* HWA: Ø§Ø­Ù…Ø± Ø¹Ù„Ù‰ ÙˆØ±Ø¯ÙŠ */
.key-hwa { background-color: #e91e63 !important; color: white !important; }
.key-hwa:nth-child(even) { background-color: #f06292 !important; }
.key-hwa td { border-bottom-color: #f06292 !important; }
.key-hwa td[contenteditable="true"] { background: #f8bbd0 !important; color: #333 !important; }

/* REAL: Ø§ØµÙØ± */
.key-real { background-color: #ffeb3b !important; color: #333 !important; }
.key-real:nth-child(even) { background-color: #fff176 !important; }
.key-real tr:hover { filter: brightness(0.9); }
.key-real td { border-bottom-color: #fff176 !important; }
.key-real td[contenteditable="true"] { background: #fffde7 !important; color: #333 !important; }

/* HNR: Ø±ØµØ§ØµÙŠ ÙØ§ØªØ­ */
.key-hnr { background-color: #bdbdbd !important; color: #333 !important; }
.key-hnr:nth-child(even) { background-color: #e0e0e0 !important; }
.key-hnr tr:hover { filter: brightness(0.9); }
.key-hnr td { border-bottom-color: #e0e0e0 !important; }
.key-hnr td[contenteditable="true"] { background: #f5f5f5 !important; color: #333 !important; }

/* TEC: Ø§Ø²Ø±Ù‚ ÙØ§ØªØ­ */
.key-tec { background-color: #03a9f4 !important; color: white !important; }
.key-tec:nth-child(even) { background-color: #4fc3f7 !important; }
.key-tec td { border-bottom-color: #4fc3f7 !important; }
.key-tec td[contenteditable="true"] { background: #b3e5fc !important; color: #333 !important; }

/* INF: Ø§Ø®Ø¶Ø± ÙØ§ØªØ­ */
.key-inf { background-color: #8bc34a !important; color: #333 !important; }
.key-inf:nth-child(even) { background-color: #c5e1a5 !important; }
.key-inf tr:hover { filter: brightness(0.9); }
.key-inf td { border-bottom-color: #c5e1a5 !important; }
.key-inf td[contenteditable="true"] { background: #f1f8e9 !important; color: #333 !important; }

/* XM: Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
.key-xm { background-color: #ff9800 !important; color: white !important; }
.key-xm:nth-child(even) { background-color: #ffb74d !important; }
.key-xm td { border-bottom-color: #ffb74d !important; }
.key-xm td[contenteditable="true"] { background: #ffe0b2 !important; color: #333 !important; }

/* OPP: Ø§Ø®Ø¶Ø± ØºØ§Ù…Ù‚ */
.key-opp { background-color: #4caf50 !important; color: white !important; }
.key-opp:nth-child(even) { background-color: #81c784 !important; }
.key-opp td { border-bottom-color: #81c784 !important; }
.key-opp td[contenteditable="true"] { background: #c8e6c9 !important; color: #333 !important; }

/* IPH: Ø§Ø³ÙˆØ¯ */
.key-iph { background-color: #212121 !important; color: white !important; }
.key-iph:nth-child(even) { background-color: #424242 !important; }
.key-iph td { border-bottom-color: #424242 !important; }
.key-iph td[contenteditable="true"] { background: #616161 !important; color: white !important; }
/* ------------------------------------------------------------------------------------ */


/* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ­ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
td[contenteditable="true"] {
    background: #e6f7ff; 
    color: #000000; 
    border-radius: 4px;
    border: 1px dashed #40a9ff; 
}

/* Ù†Ù…Ø· Ø®Ù„ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) */
td[data-final-price] {
    background: #e9f7e5; /* Ø®Ù„ÙÙŠØ© Ù…Ù…ÙŠØ²Ø© Ù„Ù„Ù†Ø§ØªØ¬ */
    font-weight: bold;
    color: #059669;
}


/* -------------------- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù€ Media Queries (Ø«Ø§Ø¨ØªØ©) -------------------- */
.switch { position: relative; display: inline-block; width: 60px; height: 34px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ef4444; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #10b981; }
input:focus + .slider { box-shadow: 0 0 1px #10b981; }
input:checked + .slider:before { transform: translateX(26px); }

.action-cell { position: relative; width: 100px; }
.options-btn { background: #1c4587; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 20px; line-height: 1; transition: background 0.3s; }
.options-dropdown { display: none; position: absolute; right: 50%; transform: translateX(50%); top: 100%; margin-top: 5px; background: white; min-width: 140px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 50; border-radius: 8px; overflow: hidden; text-align: right; }
.options-dropdown button { display: block; width: 100%; padding: 12px; border: none; background: none; text-align: right; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 14px; transition: background 0.2s; }
.options-dropdown button:hover { background: #e0e6ec; }
.options-dropdown .save-btn-dd { color: #10b981; }
.options-dropdown .delete-btn-dd { color: #ef4444; }


/* -------------------- Media Queries Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø§ØªÙ (Ø«Ø§Ø¨ØªØ©) -------------------- */
@media screen and (max-width: 768px) {
    
    #productsTable thead { display: none; }
    
    #productsTable tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #e0e6ec;
        border-radius: 10px;
        background: #fff;
    }
    
    #productsTable td {
        display: block;
        text-align: right;
        padding: 10px 10px;
        border-bottom: 1px dotted #e0e6ec;
        position: relative;
    }

    #productsTable td:nth-child(n+2):nth-last-child(2) {
        padding: 12px 55% 12px 10px; 
    }

    #productsTable td:nth-child(1):before,
    #productsTable td:nth-child(2):before,
    #productsTable td:nth-child(3):before,
    #productsTable td:nth-child(4):before,
    #productsTable td:nth-child(5):before,
    #productsTable td:nth-child(6):before,
    #productsTable td:nth-child(7):before { 
        content: attr(data-label);
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%); 
        width: 40%; 
        font-weight: bold;
        color: #1c4587;
        text-align: right;
    }
    
    /* Ø®Ù„ÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©) */
    #productsTable td:nth-last-child(1) {
        display: block; 
        width: 100%; 
        padding: 10px 10px; 
        text-align: center;
        border-top: 1px solid #e0e6ec;
        border-bottom: none;
        padding-right: 10px; 
    }
    #productsTable td:nth-last-child(1):before {
        content: none;
    }
    
    .action-cell {
        width: 100%;
        padding: 10px 15px !important; 
    }
}
</style>
</head>
<body>
<header>Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø´Ø¯ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</header>
<div class="container">

    <div id="addProductSection" class="card">
        <div class="add-form-content">
            <span id="closeAddForm" style="display: none;" onclick="toggleAddForm(false)">&times;</span> 
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="add-form">
                <input type="text" id="productName" placeholder="ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                <input type="text" id="brand" placeholder="ğŸ·ï¸ Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
                <input type="text" id="searchKey" placeholder="ğŸ”‘ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø«"> 
                <input type="number" id="wholesalePrice" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø´Ø§Ø´Ø©">
                <input type="number" id="repairPrice" placeholder="ğŸ› ï¸ Ø³Ø¹Ø± Ø§Ù„ØªØµÙ„ÙŠØ­">
                <button id="addProductButton" onclick="addProduct()">
                    â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</h2>
        
        <select id="searchKeyDropdown" onchange="filterProductsBySearchKey()">
            <option value="">-- Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª --</option>
        </select>

        <table id="productsTable">
            <thead>
                <tr>
                    <th>Ø§Ù„ØªÙˆÙØ±</th> 
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th>
                    <th>Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø«</th> 
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø§Ø´Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„ØªØµÙ„ÙŠØ­</th>
                    <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th> 
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="floating-buttons" style="display: none;">
    <button id="showAddBtn" onclick="toggleAddForm(true)">+</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase 
const firebaseConfig = {
    apiKey: "AIzaSyBpt495yhuoTbjunCLIFCF_8c1NesxZHWs",
    authDomain: "shopweb-3466b.firebaseapp.com",
    databaseURL: "https://shopweb-3466b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "shopweb-3466b",
    storageBucket: "shopweb-3466b.firebasestorage.app",
    messagingSenderId: "41811528812",
    appId: "1:41811528812:web:618f240f8106f218a8dc49",
    measurementId: "G-TQM29P5JMZ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allProductsData = {}; 
let isAddModalOpen = false;
let activeDropdownKey = null; 
let currentSelectedKey = ''; 

// -------------------- Ø¯ÙˆØ§Ù„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ --------------------

function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '';
    return Number(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function cleanNumber(text) {
    if (!text) return 0;
    return parseInt(text.replace(/,/g, '').trim()) || 0; 
}

function getRowStyleClass(searchKey) {
    if (!searchKey) return '';
    
    const key = searchKey.toUpperCase().trim(); 

    switch (key) {
        case 'SAM': return 'key-sam';
        case 'HWA': return 'key-hwa';
        case 'REAL': return 'key-real';
        case 'HNR': return 'key-hnr';
        case 'TEC': return 'key-tec';
        case 'INF': return 'key-inf';
        case 'XM': return 'key-xm';
        case 'OPP': return 'key-opp';
        case 'IPH': return 'key-iph';
        default: return ''; 
    }
}

function updateFinalPrice(row) {
    if (row.cells.length < 7) return; 
    
    const wholesalePriceCell = row.cells[4]; 
    const repairPriceCell = row.cells[5];   
    const finalPriceCell = row.cells[6];    

    const wholesale = cleanNumber(wholesalePriceCell.innerText);
    const repair = cleanNumber(repairPriceCell.innerText);
    
    const finalPrice = wholesale + repair;
    
    finalPriceCell.innerText = formatNumber(finalPrice);
}

function setupPriceListeners(row) {
    if (row.cells.length < 6) return; 
    
    const wholesaleCell = row.cells[4]; 
    const repairCell = row.cells[5];   

    const listener = () => {
        updateFinalPrice(row);
    };

    wholesaleCell.addEventListener('blur', listener);
    repairCell.addEventListener('blur', listener);
    wholesaleCell.addEventListener('input', listener); 
    repairCell.addEventListener('input', listener);
}

// -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ --------------------

function populateSearchDropdown(products) {
    const dropdown = document.getElementById('searchKeyDropdown');
    
    const currentlySelectedValue = dropdown.value; 
    
    dropdown.innerHTML = '<option value="">-- Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª --</option>'; 
    
    const uniqueKeys = new Set();
    if (products) {
        Object.keys(products).forEach(key => {
            if (products[key].searchKey) {
                uniqueKeys.add(products[key].searchKey.toUpperCase().trim());
            }
        });
    }

    const sortedKeys = Array.from(uniqueKeys).sort();

    sortedKeys.forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = key;
        dropdown.appendChild(option);
    });
    
    if (currentlySelectedValue && uniqueKeys.has(currentlySelectedValue)) {
        dropdown.value = currentlySelectedValue;
    }
    
    currentSelectedKey = dropdown.value.toUpperCase().trim();
}

function filterProductsBySearchKey() {
    const selectedKey = document.getElementById('searchKeyDropdown').value.toUpperCase().trim();
    currentSelectedKey = selectedKey; 
    const tbody = document.getElementById('productsTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = ''; 

    const colspanCount = 8;
    let found = false;

    if (!allProductsData || Object.keys(allProductsData).length === 0) {
        tbody.innerHTML = `<tr><td colspan="${colspanCount}" data-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</td></tr>`;
        return;
    }
    
    // 1. ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const filteredProducts = [];
    Object.keys(allProductsData).forEach(key => {
        const product = allProductsData[key];
        const productKey = product.searchKey ? product.searchKey.toUpperCase().trim() : '';

        if (selectedKey === '' || productKey === selectedKey) {
            filteredProducts.push({ key, product });
        }
    });

    // 2. ÙØ±Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø§Ø³Ù…)
    filteredProducts.sort((a, b) => {
        const nameA = a.product.name.toUpperCase();
        const nameB = b.product.name.toUpperCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
    });

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
    if (filteredProducts.length > 0) {
        filteredProducts.forEach(item => {
            createProductRow(item.product, item.key, tbody);
            found = true;
        });
    }


    if (!found) {
        tbody.innerHTML = `<tr><td colspan="${colspanCount}" data-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø¯Ø¯.</td></tr>`;
    }
}

// -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© --------------------

function createProductRow(product, key, tbody) {
    const row = tbody.insertRow();
    row.setAttribute('data-key', key); 
    
    const styleClass = getRowStyleClass(product.searchKey);
    if (styleClass) {
        row.classList.add(styleClass);
    } 
    
    // ØªØ·Ø¨ÙŠÙ‚ Ù†Ù…Ø· Ø¹Ø¯Ù… Ø§Ù„ØªÙˆÙØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const isChecked = product.isAvailable === true || product.isAvailable === 'true';
    if (!isChecked) {
        row.classList.add('not-available');
    }
    
    // Ø§Ù„Ø®Ù„ÙŠØ© 0: Ø§Ù„ØªÙˆÙØ±
    const availableCell = row.insertCell(0); availableCell.setAttribute('data-label', 'Ø§Ù„ØªÙˆÙØ±');
    const availableLabel = document.createElement('label');
    availableLabel.className = 'switch';
    
    const availableInput = document.createElement('input');
    availableInput.type = 'checkbox';
    availableInput.checked = isChecked;

    availableInput.onclick = function(event) {
        toggleAvailability(event, key); 
    };
    
    const availableSlider = document.createElement('span');
    availableSlider.className = 'slider';
    
    availableLabel.appendChild(availableInput);
    availableLabel.appendChild(availableSlider);
    availableCell.appendChild(availableLabel);


    const nameCell = row.insertCell(1); nameCell.innerText = product.name; nameCell.contentEditable = "true"; nameCell.setAttribute('data-label', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
    const brandCell = row.insertCell(2); brandCell.innerText = product.brand; brandCell.contentEditable = "true"; nameCell.setAttribute('data-label', 'Ø§Ù„Ù…Ø§Ø±ÙƒØ©');
    const searchKeyCell = row.insertCell(3); searchKeyCell.innerText = product.searchKey || ''; searchKeyCell.contentEditable = "true"; searchKeyCell.setAttribute('data-label', 'Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø«'); 
    
    const wholesaleCell = row.insertCell(4); wholesaleCell.innerText = formatNumber(product.wholesale); wholesaleCell.contentEditable = "true"; wholesaleCell.setAttribute('data-label', 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø§Ø´Ø©');
    
    const repairCell = row.insertCell(5); repairCell.innerText = formatNumber(product.repair); repairCell.contentEditable = "true"; repairCell.setAttribute('data-label', 'Ø³Ø¹Ø± Ø§Ù„ØªØµÙ„ÙŠØ­');

    const finalPriceCell = row.insertCell(6); 
    finalPriceCell.setAttribute('data-label', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
    finalPriceCell.setAttribute('data-final-price', 'true'); 
    
    const actionCell = row.insertCell(7); actionCell.setAttribute('data-label', 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª');
    actionCell.className = 'action-cell';

    const optionsBtn = document.createElement('button');
    optionsBtn.innerHTML = 'âš™ï¸'; 
    optionsBtn.className = 'options-btn';
    optionsBtn.onclick = function(event) {
        event.stopPropagation(); 
        toggleOptionsMenu(key);
    };
    actionCell.appendChild(optionsBtn);

    const dropdown = document.createElement('div');
    dropdown.id = `dropdown-${key}`;
    dropdown.className = 'options-dropdown';

    const saveBtn = document.createElement('button');
    saveBtn.innerText = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'; 
    saveBtn.className = 'save-btn-dd';
    saveBtn.onclick = function() { saveProduct(key); };
    dropdown.appendChild(saveBtn);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.innerText = 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬'; 
    deleteBtn.className = 'delete-btn-dd';
    deleteBtn.onclick = function() { deleteProduct(key, product.name); };
    dropdown.appendChild(deleteBtn);
    
    actionCell.appendChild(dropdown);
    
    updateFinalPrice(row);
    setupPriceListeners(row);
}

function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const brand = document.getElementById('brand').value.trim();
    const searchKey = document.getElementById('searchKey').value.trim(); 
    
    const wholesale = cleanNumber(document.getElementById('wholesalePrice').value);
    const repair = cleanNumber(document.getElementById('repairPrice').value);
    
    if(name && brand && searchKey && wholesale && repair) { 
        const newProductData = { 
            name, 
            brand, 
            searchKey, 
            wholesale: Number(wholesale), 
            repair: Number(repair), 
            isAvailable: true 
        };
        
        const newRef = db.ref('products').push(newProductData);
        const newKey = newRef.key;

        newRef.then(() => {
            allProductsData[newKey] = newProductData;
            
            populateSearchDropdown(allProductsData);
            filterProductsBySearchKey(); 
            
            document.getElementById('productName').value='';
            document.getElementById('brand').value='';
            document.getElementById('searchKey').value=''; 
            document.getElementById('wholesalePrice').value='';
            document.getElementById('repairPrice').value='';
            
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ±ØªÙŠØ¨Ù‡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
            if(window.innerWidth <= 768) toggleAddForm(false); 
        }).catch(error => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ' + error.message));
    } else { alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); }
}


function displayProducts(shouldRefreshDropdown = false) {
    db.ref('products').once('value', snapshot => {
        const products = snapshot.val();
        
        allProductsData = products; 
        
        if (shouldRefreshDropdown || !currentSelectedKey) {
            populateSearchDropdown(products);
        }

        filterProductsBySearchKey();
        
        if(!products) {
            const tbody = document.getElementById('productsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = `<tr><td colspan="8" data-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.</td></tr>`; 
            return;
        }
    });
}

// -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª --------------------

function toggleOptionsMenu(key) {
    if (activeDropdownKey && activeDropdownKey !== key) {
        document.getElementById(`dropdown-${activeDropdownKey}`).style.display = 'none';
    }
    
    const dropdown = document.getElementById(`dropdown-${key}`);
    const isVisible = dropdown.style.display === 'block';

    if (isVisible) {
        dropdown.style.display = 'none';
        activeDropdownKey = null;
    } else {
        dropdown.style.display = 'block';
        activeDropdownKey = key;
    }
}

function closeOptionsMenu() {
     if (activeDropdownKey) {
        document.getElementById(`dropdown-${activeDropdownKey}`).style.display = 'none';
        activeDropdownKey = null;
    }
}

function toggleAvailability(event, key) {
    const inputElement = event.target;
    const newStatus = inputElement.checked; 
    const row = inputElement.closest('tr');
    
    db.ref('products/' + key).update({
        isAvailable: newStatus
    }).then(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        if (allProductsData[key]) {
            allProductsData[key].isAvailable = newStatus;
        }
        
        // ØªØ·Ø¨ÙŠÙ‚/Ø¥Ø²Ø§Ù„Ø© Ù†Ù…Ø· Ø§Ù„ØªÙˆÙØ± Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ
        if (newStatus) {
            row.classList.remove('not-available');
            // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ù†Ù…Ø· Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const styleClass = getRowStyleClass(allProductsData[key].searchKey);
            if (styleClass) {
                 row.classList.add(styleClass);
            }
        } else {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Ù…Ø· Ø³Ø§Ø¨Ù‚ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„ÙØ§Ù‚Ø¹
            const styleClass = getRowStyleClass(allProductsData[key].searchKey);
            if (styleClass) {
                 row.classList.remove(styleClass);
            }
            row.classList.add('not-available');
        }
        
    }).catch(error => {
        inputElement.checked = !newStatus; 
        alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±: ' + error.message);
    });
}

function saveProduct(key) {
    closeOptionsMenu();
    const row = document.querySelector(`tr[data-key="${key}"]`);
    if (!row) return alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬.');

    const name = row.cells[1].innerText.trim();
    const brand = row.cells[2].innerText.trim();
    const searchKey = row.cells[3].innerText.trim();
    
    const wholesale = cleanNumber(row.cells[4].innerText); 
    const repair = cleanNumber(row.cells[5].innerText);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    allProductsData[key] = {
        ...allProductsData[key], 
        name: name,
        brand: brand,
        searchKey: searchKey,
        wholesale: wholesale,
        repair: repair
    };

    db.ref('products/' + key).update({ 
        name: name,
        brand: brand,
        searchKey: searchKey,
        wholesale: wholesale,
        repair: repair
    }).then(() => {
         alert('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
         // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆÙ„ÙˆÙ† Ø§Ù„ØµÙ Ø¥Ø°Ø§ ØªØºÙŠØ± Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø­Ø«
         populateSearchDropdown(allProductsData);
         filterProductsBySearchKey(); 
    });
}

function deleteProduct(key, name) {
    closeOptionsMenu();
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ${name}ØŸ`)) {
        db.ref('products/' + key).remove().then(() => {
            delete allProductsData[key];
            populateSearchDropdown(allProductsData);
            filterProductsBySearchKey();
        });
    }
}


function checkScreenSize(isResizeEvent = false) {
    const isMobile = window.innerWidth <= 768;
    const addSection = document.getElementById('addProductSection');
    const closeBtn = document.getElementById('closeAddForm');

    if (isMobile) {
        if (isResizeEvent && isAddModalOpen) {
            return;
        }

        addSection.classList.remove('card');
        closeBtn.style.display = 'block';
        
        if (!isAddModalOpen) {
            addSection.style.display = 'none';
        }

    } else {
        addSection.style.display = 'block';
        addSection.classList.add('card');
        closeBtn.style.display = 'none';
        isAddModalOpen = false; 
    }
    closeOptionsMenu(); 
}

function toggleAddForm(show) {
    const addSection = document.getElementById('addProductSection');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        if (show) {
            addSection.style.display = 'block';
            isAddModalOpen = true; 
        } else {
            addSection.style.display = 'none';
            isAddModalOpen = false; 
        }
    } 
}

document.addEventListener('click', function(e) {
    if (activeDropdownKey) {
        const dropdown = document.getElementById(`dropdown-${activeDropdownKey}`);
        const optionsBtn = dropdown.previousElementSibling; 

        if (!dropdown.contains(e.target) && e.target !== optionsBtn) {
            closeOptionsMenu();
        }
    }
});

// -------------------- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ --------------------

window.onload = function() {
    displayProducts(true); 
    checkScreenSize();
};

window.onresize = function() {
    checkScreenSize(true);
};
</script>
</body>
</html>
